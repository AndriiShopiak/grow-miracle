import { NextRequest, NextResponse } from 'next/server';
import axios from 'axios';
import { cultivars } from '@/data/products';
import { getProductPrice, getProductPriceByHeight } from '@/utils/productUtils';

const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { items, customerInfo } = body;

    if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
      return NextResponse.json(
        { error: 'Telegram configuration missing' },
        { status: 500 }
      );
    }

    // –§–æ—Ä–º—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è Telegram
    let message = `üõí *–ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ —Å–∞–π—Ç—É –°–∞–¥ –û–ª–µ–≥–∞*\n\n`;
    
    // –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞
    message += `üë§ *–ö–ª—ñ—î–Ω—Ç:*\n`;
    message += `–Ü–º'—è: ${customerInfo.name}\n`;
    message += `–ü—Ä—ñ–∑–≤–∏—â–µ: ${customerInfo.surname}\n`;
    message += `–¢–µ–ª–µ—Ñ–æ–Ω: ${customerInfo.phone}\n`;
    if (customerInfo.email) {
      message += `Email: ${customerInfo.email}\n`;
    }
    
    // –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É
    message += `\nüöö *–î–æ—Å—Ç–∞–≤–∫–∞ (–ù–æ–≤–∞ –ü–æ—à—Ç–∞):*\n`;
    
    // –ù–æ–≤—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –ø–æ–ª—è
    if (customerInfo.npCityName) {
      message += `üìç –ú—ñ—Å—Ç–æ: ${customerInfo.npCityName}\n`;
    }
    if (customerInfo.npWarehouseNumber && customerInfo.npWarehouseAddress) {
      message += `üè¢ –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ${customerInfo.npWarehouseNumber}: ${customerInfo.npWarehouseAddress}\n`;
    }
    
    // –°—Ç–∞—Ä—ñ –ø–æ–ª—è (—è–∫—â–æ —î)
    if (customerInfo.novaPoshtaAddress) {
      message += `üìù –î–æ–¥–∞—Ç–∫–æ–≤–∞ –∞–¥—Ä–µ—Å–∞: ${customerInfo.novaPoshtaAddress}\n`;
    }
    if (customerInfo.novaPoshtaBranchNumber && !customerInfo.npWarehouseNumber) {
      message += `üè¢ –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è: ${customerInfo.novaPoshtaBranchNumber}\n`;
    }
    
    if (customerInfo.comments) {
      message += `\nüí¨ *–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ:* ${customerInfo.comments}\n`;
    }
    
    message += `\nüì¶ *–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è:*\n`;
    
    let totalItems = 0;
    let totalAmount = 0;
    items.forEach((item: { id: number; title: string; qty: number; price?: number; height?: string; priceLabel?: string }, index: number) => {
      // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø—Ä–æ–¥—É–∫—Ç –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—ó —Ü—ñ–Ω–∏ —Ç–∞ –¥–µ—Ç–∞–ª–µ–π
      const product = cultivars.find(p => p.id === item.id);
      
      // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É —Ü—ñ–Ω—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤–∏—Å–æ—Ç–∏ —Å–∞–¥–∂–∞–Ω—Ü—è
      let itemPrice: number;
      let priceText: string;
      
      if (product && item.height) {
        // –Ø–∫—â–æ —î –≤–∏—Å–æ—Ç–∞ —Å–∞–¥–∂–∞–Ω—Ü—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ getProductPriceByHeight
        itemPrice = getProductPriceByHeight(product, item.height);
        priceText = item.priceLabel || `${itemPrice} –≥—Ä–Ω/—à—Ç (${item.height})`;
      } else if (product) {
        // –Ø–∫—â–æ –Ω–µ–º–∞—î –≤–∏—Å–æ—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —Ü—ñ–Ω—É
        itemPrice = getProductPrice(product);
        priceText = item.priceLabel || product?.price || `${itemPrice} –≥—Ä–Ω/—à—Ç`;
      } else {
        // Fallback –Ω–∞ —Ü—ñ–Ω—É –∑ –∫–æ—Ä–∑–∏–Ω–∏ –∞–±–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É
        itemPrice = item.price || 800;
        priceText = item.priceLabel || `${itemPrice} –≥—Ä–Ω/—à—Ç`;
      }
      
      const itemSum = item.qty * itemPrice;
      
      message += `${index + 1}. ${item.title}`;
      if (product) {
        message += ` (${product.species})`;
        if (product.rootSystem) {
          message += ` [${product.rootSystem === 'open' ? '–í–ö–°' : '–ó–ö–°'}]`;
        }
      }
      
      // –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤–∏—Å–æ—Ç—É —Å–∞–¥–∂–∞–Ω—Ü—è, —è–∫—â–æ —î
      if (item.height && item.height !== 'standard') {
        message += `\n   üìè –í–∏—Å–æ—Ç–∞: ${item.height}`;
      }
      
      message += ` ‚Äî ${item.qty} —à—Ç. √ó ${priceText} = ${itemSum.toLocaleString('uk-UA')} –≥—Ä–Ω\n`;
      totalItems += item.qty;
      totalAmount += itemSum;
    });
    
    message += `\nüìä *–ü—ñ–¥—Å—É–º–æ–∫:*\n`;
    message += `–í—Å—å–æ–≥–æ –ø–æ–∑–∏—Ü—ñ–π: ${items.length}\n`;
    message += `–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å: ${totalItems} —à—Ç.\n`;
    message += `–î–æ —Å–ø–ª–∞—Ç–∏: ${totalAmount.toLocaleString('uk-UA')} –≥—Ä–Ω\n`;
    // –î–æ–¥–∞—î–º–æ +3 –≥–æ–¥–∏–Ω–∏ –¥–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —á–∞—Å—É –¥–ª—è –£–∫—Ä–∞—ó–Ω–∏ (UTC+3)
    const serverTime = new Date();
    const ukraineTime = new Date(serverTime.getTime() + 3 * 60 * 60 * 1000);
    message += `\n‚è∞ –ß–∞—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ${ukraineTime.toLocaleString('uk-UA')}`;

    // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram
    const telegramResponse = await axios.post(
      `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,
      {
        chat_id: TELEGRAM_CHAT_ID,
        text: message,
        parse_mode: 'Markdown',
      }
    );

    if (telegramResponse.data.ok) {
      return NextResponse.json({ success: true });
    } else {
      throw new Error('Failed to send message to Telegram');
    }
  } catch (error) {
    console.error('Error sending to Telegram:', error);
    return NextResponse.json(
      { error: 'Failed to send order to Telegram' },
      { status: 500 }
    );
  }
}
